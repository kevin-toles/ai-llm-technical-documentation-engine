# CodeRabbit Manual Analysis Makefile - LLM Document Enhancer
.PHONY: help install-tools coderabbit-quick coderabbit-full coderabbit-security coderabbit-setup clean-reports

# Default target
help:
	@echo "CodeRabbit Manual Analysis Commands (LLM Document Enhancer):"
	@echo "  make -f Makefile.coderabbit install-tools        - Install all required analysis tools"
	@echo "  make -f Makefile.coderabbit coderabbit-setup     - Set up CodeRabbit configuration and tools"
	@echo "  make -f Makefile.coderabbit coderabbit-quick     - Run quick CodeRabbit analysis (manual)"
	@echo "  make -f Makefile.coderabbit coderabbit-full      - Run comprehensive CodeRabbit analysis (manual)"
	@echo "  make -f Makefile.coderabbit coderabbit-security  - Run security-focused analysis (manual)"
	@echo "  make -f Makefile.coderabbit coderabbit-manual    - Run manual analysis via script"
	@echo "  make -f Makefile.coderabbit clean-reports        - Clean analysis reports"
	@echo ""
	@echo "ğŸ¯ Manual Trigger Design: CodeRabbit runs only when explicitly requested"
	@echo "ğŸ”§ Use: ./scripts/run_coderabbit_analysis.sh [quick|full|security]"

# Install analysis tools
install-tools:
	@echo "ğŸ”§ Installing CodeRabbit analysis tools..."
	pip install --upgrade pip
	pip install bandit flake8 mypy radon ruff safety pydocstyle
	pip install pre-commit
	@echo "âœ… Tools installed successfully"

# Set up CodeRabbit
coderabbit-setup: install-tools
	@echo "ğŸš€ Setting up CodeRabbit manual analysis..."
	mkdir -p reports/coderabbit
	chmod +x scripts/run_coderabbit_analysis.sh
	@echo "âœ… CodeRabbit manual setup complete"
	@echo "ğŸ”§ Use: ./scripts/run_coderabbit_analysis.sh or make commands"

# Manual analysis via script
coderabbit-manual:
	@echo "ğŸ¯ Running manual CodeRabbit analysis via script..."
	./scripts/run_coderabbit_analysis.sh full

# Quick analysis (essential checks only)
coderabbit-quick:
	@echo "âš¡ Running quick CodeRabbit analysis (manual trigger)..."
	./scripts/run_coderabbit_analysis.sh quick

# Full comprehensive analysis
coderabbit-full:
	@echo "ğŸ” Running comprehensive CodeRabbit analysis (manual trigger)..."
	./scripts/run_coderabbit_analysis.sh full

# Security-focused analysis
coderabbit-security:
	@echo "ğŸ”’ Running security-focused analysis (manual trigger)..."
	./scripts/run_coderabbit_analysis.sh security

# PR-ready analysis (what would run in CI)
coderabbit-pr: clean-reports
	@echo "ğŸ” Running PR-ready CodeRabbit analysis..."
	mkdir -p reports/coderabbit
	python scripts/local_coderabbit.py --path . --format both
	@echo ""
	@echo "ğŸ“‹ PR Analysis Summary:"
	@if [ -f "reports/coderabbit/analysis_results.json" ]; then \
		python -c "import json; data=json.load(open('reports/coderabbit/analysis_results.json')); print(f\"ğŸš¨ Critical: {data['summary']['by_severity'].get('critical', 0)}\"); print(f\"ğŸ”´ High: {data['summary']['by_severity'].get('high', 0)}\"); print(f\"ğŸŸ¡ Medium: {data['summary']['by_severity'].get('medium', 0)}\"); print(f\"ğŸ“Š Total: {data['summary']['total_issues']}\")"; \
	fi
	@echo "âœ… PR analysis complete"

# Run pre-commit hooks
coderabbit-precommit:
	@echo "ğŸ”§ Running pre-commit CodeRabbit checks..."
	pre-commit run --all-files

# Clean reports
clean-reports:
	@echo "ğŸ§¹ Cleaning analysis reports..."
	rm -rf reports/coderabbit/*
	@echo "âœ… Reports cleaned"

# Integration with SonarQube
coderabbit-with-sonar: coderabbit-full
	@echo "ğŸ”— Running CodeRabbit + SonarQube analysis..."
	@echo "âš ï¸  SonarQube integration requires separate configuration"
	@echo "ï¿½ Set SONAR_TOKEN environment variable before running"

# Watch mode for development
coderabbit-watch:
	@echo "ğŸ‘ï¸  Starting CodeRabbit watch mode..."
	@echo "ğŸ”„ Run 'make coderabbit-quick' in another terminal to analyze changes"
	@while true; do \
		inotifywait -r -e modify,create,delete --include='.*\.py$$' . 2>/dev/null && \
		echo "ğŸ“ Python files changed - run 'make coderabbit-quick' to analyze"; \
	done

# Generate project health report
coderabbit-health: coderabbit-full
	@echo "ğŸ¥ Generating project health report..."
	@python -c "
import json
import os
from datetime import datetime

if os.path.exists('reports/coderabbit/analysis_results.json'):
    with open('reports/coderabbit/analysis_results.json') as f:
        data = json.load(f)
    
    total = data['summary']['total_issues']
    critical = data['summary']['by_severity'].get('critical', 0)
    high = data['summary']['by_severity'].get('high', 0)
    medium = data['summary']['by_severity'].get('medium', 0)
    
    # Calculate health score (0-100)
    health_score = max(0, 100 - (critical * 10) - (high * 3) - (medium * 1))
    
    print(f'ğŸ“Š Project Health Report')
    print(f'========================')
    print(f'Health Score: {health_score}/100')
    print(f'Total Issues: {total}')
    print(f'Critical: {critical} ğŸš¨')
    print(f'High: {high} ğŸ”´')
    print(f'Medium: {medium} ğŸŸ¡')
    
    if health_score >= 90:
        print('âœ… Excellent code health!')
    elif health_score >= 70:
        print('ğŸŸ¡ Good code health with room for improvement')
    elif health_score >= 50:
        print('ğŸŸ  Fair code health - consider addressing issues')
    else:
        print('ğŸš¨ Poor code health - immediate attention needed')
else:
    print('âš ï¸  No analysis results found - run coderabbit-full first')
"